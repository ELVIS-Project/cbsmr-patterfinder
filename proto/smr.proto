syntax = "proto3";

package proto;

message Piece {
    bytes symbolicData = 1;
    string encoding = 2;
    string name = 3;
}

message Note {
    float onset = 1;
    float offset = 2;
    int32 pitchB40 = 3;

    uint32 pieceIdx = 6;

    uint32 measureNumber = 5; 
    uint32 measureIdx = 7;
}

message Measure {
    bytes symbolicData = 1;
    uint32 number = 2;
    uint32 noteIdx = 3;
}

message Vector {
    Note left = 1;
    Note right = 2;
}


service Indexer {
    rpc IndexPiece (IndexRequest) returns (IndexResponse);
}
	
service Searcher{
    rpc Search (SearchRequest) returns (SearchResponse);
}

enum IndexType {
    UNKNOWN = 0; // forward compatibility with enum version change
    NOTE = 1;
    MEASURE = 2;
    VECTORS = 3;
}

message IndexRequest {
    Piece piece = 1;
    IndexType type = 2;
}

message IndexResponse {
    repeated Note notes = 1;
    repeated Measure measures = 2;
    repeated Vector vectors = 3;
}

message SearchRequest {
	repeated Note query = 1;
}

message SearchResponse {
	// If it's fast enough, we could just make this a repeated Measure
  repeated Occurrence occs = 1;
}

message Occurrence {
	uint32 pieceId = 1;
	repeated uint32 noteIdx = 2;
	repeated Measure highlightedExcerpt = 3;
}
